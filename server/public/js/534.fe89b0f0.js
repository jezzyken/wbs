"use strict";(self["webpackChunkclient"]=self["webpackChunkclient"]||[]).push([[534],{8319:function(t,e,i){i.r(e),i.d(e,{default:function(){return z}});var s=i(7314),a=i(3698),n=i(2938),r=i(569),o=i(6993),c=(i(4114),i(8111),i(2489),i(3579),i(4746)),l=i(5471),u=l.Ay.extend({name:"rippleable",directives:{ripple:c.A},props:{ripple:{type:[Boolean,Object],default:!0}},methods:{genRipple(t={}){return this.ripple?(t.staticClass="v-input--selection-controls__ripple",t.directives=t.directives||[],t.directives.push({name:"ripple",value:{center:!0}}),this.$createElement("div",t)):null}}}),m=i(8968),d=i(5803);function h(t){t.preventDefault()}var p=(0,d.A)(o.A,u,m.A).extend({name:"selectable",model:{prop:"inputValue",event:"change"},props:{id:String,inputValue:null,falseValue:null,trueValue:null,multiple:{type:Boolean,default:null},label:String},data(){return{hasColor:this.inputValue,lazyValue:this.inputValue}},computed:{computedColor(){if(this.isActive)return this.color?this.color:this.isDark&&!this.appIsDark?"white":"primary"},isMultiple(){return!0===this.multiple||null===this.multiple&&Array.isArray(this.internalValue)},isActive(){const t=this.value,e=this.internalValue;return this.isMultiple?!!Array.isArray(e)&&e.some((e=>this.valueComparator(e,t))):void 0===this.trueValue||void 0===this.falseValue?t?this.valueComparator(t,e):Boolean(e):this.valueComparator(e,this.trueValue)},isDirty(){return this.isActive},rippleState(){return this.isDisabled||this.validationState?this.validationState:void 0}},watch:{inputValue(t){this.lazyValue=t,this.hasColor=t}},methods:{genLabel(){const t=o.A.options.methods.genLabel.call(this);return t?(t.data.on={click:h},t):t},genInput(t,e){return this.$createElement("input",{attrs:Object.assign({"aria-checked":this.isActive.toString(),disabled:this.isDisabled,id:this.computedId,role:t,type:t},e),domProps:{value:this.value,checked:this.isActive},on:{blur:this.onBlur,change:this.onChange,focus:this.onFocus,keydown:this.onKeydown,click:h},ref:"input"})},onClick(t){this.onChange(),this.$emit("click",t)},onChange(){if(!this.isInteractive)return;const t=this.value;let e=this.internalValue;if(this.isMultiple){Array.isArray(e)||(e=[]);const i=e.length;e=e.filter((e=>!this.valueComparator(e,t))),e.length===i&&e.push(t)}else e=void 0!==this.trueValue&&void 0!==this.falseValue?this.valueComparator(e,this.trueValue)?this.falseValue:this.trueValue:t?this.valueComparator(e,t)?null:t:!e;this.validate(!0,e),this.internalValue=e,this.hasColor=e},onFocus(t){this.isFocused=!0,this.$emit("focus",t)},onBlur(t){this.isFocused=!1,this.$emit("blur",t)},onKeydown(t){}}}),v=p.extend({name:"v-checkbox",props:{indeterminate:Boolean,indeterminateIcon:{type:String,default:"$checkboxIndeterminate"},offIcon:{type:String,default:"$checkboxOff"},onIcon:{type:String,default:"$checkboxOn"}},data(){return{inputIndeterminate:this.indeterminate}},computed:{classes(){return{...o.A.options.computed.classes.call(this),"v-input--selection-controls":!0,"v-input--checkbox":!0,"v-input--indeterminate":this.inputIndeterminate}},computedIcon(){return this.inputIndeterminate?this.indeterminateIcon:this.isActive?this.onIcon:this.offIcon},validationState(){if(!this.isDisabled||this.inputIndeterminate)return this.hasError&&this.shouldValidate?"error":this.hasSuccess?"success":null!==this.hasColor?this.computedColor:void 0}},watch:{indeterminate(t){this.$nextTick((()=>this.inputIndeterminate=t))},inputIndeterminate(t){this.$emit("update:indeterminate",t)},isActive(){this.indeterminate&&(this.inputIndeterminate=!1)}},methods:{genCheckbox(){const{title:t,...e}=this.attrs$;return this.$createElement("div",{staticClass:"v-input--selection-controls__input"},[this.$createElement(r.A,this.setTextColor(this.validationState,{props:{dense:this.dense,dark:this.dark,light:this.light}}),this.computedIcon),this.genInput("checkbox",{...e,"aria-checked":this.inputIndeterminate?"mixed":this.isActive.toString()}),this.genRipple(this.setTextColor(this.rippleState))])},genDefaultSlot(){return[this.genCheckbox(),this.genLabel()]}}}),y=i(3180),f=i(4414),b=i(3449),g=i(9483),A=i(8983),C=i(7296),_=i(2659),x=i(8519),k=i(2756),w=i(7150),R=i(7112),I=function(){var t=this,e=t._self._c;return e(b.A,{staticClass:"pa-0",attrs:{fluid:""}},[e(a.A,{staticClass:"mb-4",attrs:{flat:""}},[e(n.OQ,[e("div",{staticClass:"text-caption grey--text mb-1"},[t._v(" Home / Payments / New Payment ")]),e("div",{staticClass:"text-h5 primary--text font-weight-bold"},[t._v("New Payment")])])],1),e(b.A,[e(k.A,[e(f.A,{attrs:{cols:"12",md:"8"}},[e(a.A,[e(n.ri,{staticClass:"grey lighten-4"},[t._v("Payment Processing")]),e(n.OQ,[e(k.A,{staticClass:"grey lighten-5 pa-4 mb-4"},[e(f.A,{attrs:{cols:"12",sm:"6",md:"3"}},[e("div",{staticClass:"caption grey--text"},[t._v("Account No.")]),e("div",{staticClass:"body-1 font-weight-medium"},[t._v(" "+t._s(t.consumer.accountNo)+" ")])]),e(f.A,{attrs:{cols:"12",sm:"6",md:"3"}},[e("div",{staticClass:"caption grey--text"},[t._v("Consumer Name")]),e("div",{staticClass:"body-1 font-weight-medium"},[t._v(" "+t._s(t.consumer.name)+" ")])]),e(f.A,{attrs:{cols:"12",sm:"6",md:"3"}},[e("div",{staticClass:"caption grey--text"},[t._v("Consumer Type")]),e(y.A,{attrs:{"x-small":"",color:"warning",label:""}},[t._v(t._s(t.consumer.type))])],1),e(f.A,{attrs:{cols:"12",sm:"6",md:"3"}},[e("div",{staticClass:"caption grey--text"},[t._v("Status")]),e("div",{staticClass:"body-1 font-weight-medium"},[t._v(" "+t._s(t.consumer.status)+" ")])])],1),e("div",{staticClass:"mb-6"},[e("div",{staticClass:"text-subtitle-1 primary--text font-weight-medium mb-3"},[t._v(" Select Transactions ")]),e(a.A,{attrs:{outlined:""}},[e(A.A,t._l(t.displayedFees,(function(i,s){return e(C.A,{key:s},[e(_.A,[e(v,{attrs:{disabled:i.disabled},model:{value:i.selected,callback:function(e){t.$set(i,"selected",e)},expression:"fee.selected"}})],1),e(x.pr,[e(x.UZ,[t._v(t._s(i.name))]),e(x.w,{staticClass:"text-caption"},[t._v(" "+t._s(i.description)+" ")])],1),e(_.A,[t._v("â‚±"+t._s(i.amount.toFixed(2)))])],1)})),1)],1)],1),e("div",{staticClass:"mb-6"},[e("div",{staticClass:"text-subtitle-1 primary--text font-weight-medium mb-3"},[t._v(" Payment Details ")]),e(R.A,{attrs:{label:"Amount Received",prefix:"â‚±",type:"number",outlined:"",dense:"","error-messages":t.amountReceivedError,min:"0",step:"0.01"},model:{value:t.amountReceived,callback:function(e){t.amountReceived=e},expression:"amountReceived"}}),e(a.A,{staticClass:"grey lighten-5 mb-4",attrs:{outlined:""}},[e(C.A,[e(x.pr,[t._v("Amount Received")]),e(_.A,[t._v("â‚±"+t._s(t.amountReceived))])],1),e(C.A,[e(x.pr,[t._v("Total Amount Due")]),e(_.A,[t._v("â‚±"+t._s(t.totalAmountDue.toFixed(2)))])],1),e(g.A),e(C.A,[e(x.pr,[t._v("Change")]),e(_.A,{staticClass:"success--text font-weight-bold"},[t._v(" â‚±"+t._s(t.calculateChange.toFixed(2))+" ")])],1)],1)],1)],1)],1)],1),e(f.A,{attrs:{cols:"12",md:"4"}},[e(a.A,[e(n.ri,{staticClass:"primary white--text"},[t._v("Transaction Summary")]),e(n.OQ,{staticClass:"pt-4"},[t._l(t.summaryItems,(function(i,s){return e(C.A,{key:s},[e(x.pr,[e(x.UZ,[t._v(t._s(i.name))])],1),e(_.A,[t._v("â‚±"+t._s(i.amount.toFixed(2)))])],1)})),e(g.A,{staticClass:"my-4"}),e(C.A,{staticClass:"font-weight-bold"},[e(x.pr,[e(x.UZ,[t._v("Total Amount Due")])],1),e(_.A,[t._v("â‚±"+t._s(t.totalAmountDue.toFixed(2)))])],1),e(s.A,{staticClass:"mt-6",attrs:{color:"primary",block:"",disabled:!t.isValidPayment||!!t.amountReceivedError,loading:t.loading},on:{click:t.processPayment}},[t._v(" "+t._s(t.loading?"Processing...":"Process Payment")+" ")]),e(s.A,{staticClass:"mt-2",attrs:{block:"",text:"",disabled:t.loading},on:{click:t.cancel}},[t._v(" Cancel ")])],2)],1)],1)],1)],1),e(w.A,{attrs:{color:t.snackbarColor,timeout:"3000"},scopedSlots:t._u([{key:"action",fn:function({attrs:i}){return[e(s.A,t._b({attrs:{text:""},on:{click:function(e){t.snackbar=!1}}},"v-btn",i,!1),[t._v("Close")])]}}]),model:{value:t.snackbar,callback:function(e){t.snackbar=e},expression:"snackbar"}},[t._v(" "+t._s(t.snackbarText)+" ")]),e("receipt-print-dialog",{attrs:{payment:t.receiptData},model:{value:t.showReceiptDialog,callback:function(e){t.showReceiptDialog=e},expression:"showReceiptDialog"}})],1)},D=[],$=(i(116),i(1701),i(8237),i(5353)),P=i(1289),T=i(6930),S=i(1034),E=function(){var t=this,e=t._self._c;return e(P.A,{attrs:{"max-width":"400px"},model:{value:t.dialog,callback:function(e){t.dialog=e},expression:"dialog"}},[e(a.A,[e(n.ri,{staticClass:"headline primary white--text"},[t._v(" Review Receipt ")]),e(n.OQ,{staticClass:"pa-4"},[e("div",{staticClass:"receipt-preview"},[e("div",{staticClass:"text-center mb-4"},[e("div",{staticClass:"text-h6 font-weight-bold"},[t._v("BASAK WATER DISTRICT")]),e("div",{staticClass:"text-subtitle-1"},[t._v("Official Receipt")]),e("div",{staticClass:"text-caption"},[t._v(" "+t._s(t.formatDate(t.payment.date))+" ")])]),e(a.A,{staticClass:"mb-4 pa-3",attrs:{outlined:""}},[e("div",[e("strong",[t._v("Account No:")]),t._v(" "+t._s(t.payment.consumer.accountNo))]),e("div",[e("strong",[t._v("Consumer:")]),t._v(" "+t._s(t.payment.consumer.name))]),e("div",[e("strong",[t._v("Status:")]),t._v(" "+t._s(t.payment.consumer.status))])]),e("div",{staticClass:"text-subtitle-1 font-weight-medium mb-2"},[t._v("Payment Details")]),e(a.A,{staticClass:"mb-4",attrs:{outlined:""}},[e(A.A,{attrs:{dense:""}},t._l(t.payment.items,(function(i,s){return e(C.A,{key:s},[e(x.pr,[e(x.UZ,[t._v(t._s(i.name))]),e(x.w,{staticClass:"text-caption"},[t._v(" "+t._s(i.description)+" ")])],1),e(_.A,{staticClass:"text-right"},[t._v(" â‚±"+t._s(i.amount.toFixed(2))+" ")])],1)})),1)],1),e(a.A,{staticClass:"mb-4",attrs:{outlined:""}},[e(A.A,{attrs:{dense:""}},[e(C.A,[e(x.pr,[t._v("Total Amount Due")]),e(_.A,{staticClass:"font-weight-medium"},[t._v(" â‚±"+t._s(t.payment.totalAmount.toFixed(2))+" ")])],1),e(C.A,[e(x.pr,[t._v("Amount Received")]),e(_.A,{staticClass:"font-weight-medium"},[t._v(" â‚±"+t._s(t.payment.amountReceived.toFixed(2))+" ")])],1),e(g.A),e(C.A,[e(x.pr,[t._v("Change")]),e(_.A,{staticClass:"success--text font-weight-bold"},[t._v(" â‚±"+t._s(t.payment.change.toFixed(2))+" ")])],1)],1)],1),e("div",{staticClass:"text-center text-caption grey--text"},[e("div",[t._v("Thank you for your payment!")]),e("div",[t._v("Keep this receipt for future reference")]),e("div",[t._v(t._s(t.generateReceiptNumber()))])])],1)]),e(g.A),e(n.SL,{staticClass:"pa-4"},[e(S.A),e(s.A,{attrs:{text:"",disabled:t.loading},on:{click:t.close}},[t._v(" Cancel ")]),e(s.A,{attrs:{color:"primary",loading:t.loading,disabled:t.loading},on:{click:t.print}},[e(T.A,{attrs:{left:""}},[t._v("mdi-printer")]),t._v(" Print ")],1)],1)],1),e(w.A,{attrs:{color:t.snackbarColor,timeout:3e3},scopedSlots:t._u([{key:"action",fn:function({attrs:i}){return[e(s.A,t._b({attrs:{text:""},on:{click:function(e){t.snackbar=!1}}},"v-btn",i,!1),[t._v(" Close ")])]}}]),model:{value:t.snackbar,callback:function(e){t.snackbar=e},expression:"snackbar"}},[t._v(" "+t._s(t.snackbarText)+" ")])],1)},F=[],B={name:"ReceiptPrintDialog",props:{value:{type:Boolean,default:!1},payment:{type:Object}},data:()=>({loading:!1,snackbar:!1,snackbarText:"",snackbarColor:"success"}),computed:{dialog:{get(){return this.value},set(t){this.$emit("input",t)}}},methods:{formatDate(t){return new Date(t).toLocaleString("en-PH",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})},generateReceiptNumber(){const t=(new Date).getTime();return`Receipt #: ${t}`},async print(){this.loading=!0;try{await this.$parent.printReceipt(),this.snackbarText="Receipt printed successfully",this.snackbarColor="success",this.snackbar=!0,setTimeout((()=>{this.close(),this.$router.push({name:"ConsumerRecords",params:{refreshData:!0}})}),1e3)}catch(t){console.error("Print failed:",t),this.snackbarText="Failed to print receipt",this.snackbarColor="error",this.snackbar=!0}finally{this.loading=!1}},close(){this.loading||(this.dialog=!1,this.$router.push({name:"ConsumerRecords"}))}}},V=B,N=i(1656),L=(0,N.A)(V,E,F,!1,null,"1f978af7",null),O=L.exports,M={name:"PaymentPage",components:{ReceiptPrintDialog:O},data:()=>({consumer:{accountNo:"",name:"",type:"",status:""},fees:[{name:"Current Bill",amount:0,selected:!0,disabled:!0,description:"Current water bill payment",paymentType:"BILL_PAYMENT"},{name:"Unpaid Balance",amount:0,selected:!0,disabled:!0,description:"Unpaid balance",paymentType:"BILL_PAYMENT"},{name:"Membership Fee",amount:300,selected:!1,disabled:!1,description:"One-time membership fee for new consumers",paymentType:"MEMBERSHIP_FEE"},{name:"Reconnection Fee",amount:50,selected:!1,disabled:!1,description:"Water reconnection service fee",paymentType:"RECONNECTION_FEE"}],amountReceived:0,loading:!1,snackbar:!1,snackbarText:"",snackbarColor:"",printer:{device:null,characteristic:null,isConnected:!1,loading:!1},showReceiptDialog:!1,receiptData:null}),computed:{...(0,$.aH)("consumers",["currentConsumer"]),...(0,$.aH)("billings",["currentBill"]),displayedFees(){if("true"===this.$route.query.new)return this.fees.filter((t=>"Membership Fee"===t.name));let t=this.fees.filter((t=>"Current Bill"===t.name));const e=this.fees.find((t=>"Unpaid Balance"===t.name));if(e&&e.amount>0&&t.push(e),"disconnected"===this.consumer.status.toLowerCase()){const e=this.fees.find((t=>"Reconnection Fee"===t.name));e&&t.push(e)}return t},summaryItems(){return this.fees.filter((t=>t.selected)).map((t=>({name:t.name,amount:t.amount,description:t.description,paymentType:t.paymentType,billId:t.billId,billIds:t.billIds})))},totalAmountDue(){return this.summaryItems.reduce(((t,e)=>t+e.amount),0)},calculateChange(){return this.amountReceived-this.totalAmountDue},isValidPayment(){return this.amountReceived>=this.totalAmountDue&&this.totalAmountDue>0},amountReceivedError(){return this.amountReceived<this.totalAmountDue?"Amount received must be greater than or equal to total amount due":""}},watch:{amountReceived(t){const e=parseFloat(t);this.amountReceived=e<0?0:e}},async created(){await this.initializePaymentData()},methods:{...(0,$.i0)("consumers",["fetchConsumerById"]),...(0,$.i0)("billings",["fetchBillById","fetchUnpaidBills","updateBill"]),async ensurePrinterConnection(){return!!this.printer.isConnected||this.initializePrinter()},async initializePrinter(){if(this.printer.isConnected)return!0;try{const t=await navigator.bluetooth.requestDevice({filters:[{services:["000018f0-0000-1000-8000-00805f9b34fb"]},{namePrefix:"POS"}]}),e=await t.gatt.connect(),i=await e.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb"),s=await i.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb");return this.printer={device:t,characteristic:s,isConnected:!0,loading:!1},t.addEventListener("gattserverdisconnected",(()=>{this.printer.isConnected=!1})),!0}catch(t){return console.error("Printer initialization error:",t),this.printer.isConnected=!1,!1}},async initializePaymentData(){try{if("true"===this.$route.query.new){const t=this.$route.params.consumerData;this.consumer={accountNo:t.accountNo,name:`${t.firstName} ${t.lastName}`,type:t.consumerType,status:t.status},this.fees=this.fees.filter((t=>"Membership Fee"===t.name));const e=this.fees[0];e&&(e.selected=!0,e.disabled=!0,this.amountReceived=e.amount)}else{const t=await this.fetchBillById(this.$route.query.billId),e=await this.fetchConsumerById(this.$route.query.consumerId);this.consumer={accountNo:e.accountNo,name:`${e.firstName} ${e.lastName}`,type:e.consumerType||"old",status:e.status};const i=this.fees.find((t=>"Current Bill"===t.name));i&&(i.amount=t.amount,i.billId=t._id);const s=await this.fetchUnpaidBills(this.$route.query.consumerId),a=s.filter((e=>e._id!==t._id)),n=a.reduce(((t,e)=>t+e.amount),0),r=this.fees.find((t=>"Unpaid Balance"===t.name));if(r&&(r.amount=n,r.billIds=a.map((t=>t._id))),"disconnected"===e.status.toLowerCase()){const t=this.fees.find((t=>"Reconnection Fee"===t.name));t&&(t.selected=!0,t.disabled=!1)}}}catch(t){this.snackbarText="Error initializing payment data",this.snackbarColor="error",this.snackbar=!0}},async processPayment(){if(this.isValidPayment&&!this.amountReceivedError){this.loading=!0;try{const t="true"===this.$route.query.new,e=t?this.$route.params.consumerData:null,i={consumerData:t?e:null,amount:this.totalAmountDue,amountReceived:parseFloat(this.amountReceived),change:this.calculateChange,paymentType:t?"MEMBERSHIP_FEE":"BILL_PAYMENT",selectedFees:this.summaryItems,paymentMethod:"CASH",status:"completed",notes:`Payment for ${this.summaryItems.map((t=>t.name)).join(", ")}`,consumerId:t?null:this.$route.query.consumerId};await this.$store.dispatch("payments/createPayment",i);this.receiptData={consumer:t?e:this.consumer,items:this.summaryItems,totalAmount:this.totalAmountDue,amountReceived:parseFloat(this.amountReceived),change:this.calculateChange,date:new Date},this.showReceiptDialog=!0,this.snackbarText="Payment processed successfully",this.snackbarColor="success",this.snackbar=!0}catch(t){this.snackbarText=t.message||"Error processing payment",this.snackbarColor="error",this.snackbar=!0}finally{this.loading=!1}}},async printReceipt(){try{this.printer.isConnected||await this.initializePrinter();const t="",e="",i=`${t}a1`,s=`${t}a0`,a=`${t}E1`,n=`${t}E0`,r=`${t}@`,o=`${e}V1`,c=[r,i,a,"BASAK WATER DISTRICT\n",n,"Official Receipt\n",`${(new Date).toLocaleDateString()}\n`,`${(new Date).toLocaleTimeString()}\n`,"--------------------------------\n",s,`Account No: ${this.consumer.accountNo}\n`,`Consumer : ${this.consumer.name}\n`,"--------------------------------\n",...this.summaryItems.map((t=>`${t.name}\n`+"Amount:".padEnd(24)+`P${t.amount.toFixed(2)}\n`)),"--------------------------------\n",a,`Total Amount Due : P${this.totalAmountDue.toFixed(2)}\n`,`Amount Received  : P${this.amountReceived}\n`,`Change          : P${this.calculateChange.toFixed(2)}\n`,"--------------------------------\n",i,n,"Thank you for your payment!\n\n",i,"Keep this receipt for future reference\n","\n\n\n",o].join(""),l=new TextEncoder,u=l.encode(c),m=50;for(let d=0;d<u.length;d+=m){const t=u.slice(d,d+m);await this.printer.characteristic.writeValue(t),await new Promise((t=>setTimeout(t,50)))}return!0}catch(t){return console.error("Print error:",t),!1}},cancel(){confirm("Are you sure you want to cancel? Any unsaved changes will be lost.")&&this.$router.push({name:"true"===this.$route.query.newConsumer?"ConsumerRecords":"Billing"})}}},q=M,U=(0,N.A)(q,I,D,!1,null,"1781ba86",null),z=U.exports}}]);
//# sourceMappingURL=534.fe89b0f0.js.map